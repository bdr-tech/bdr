<% content_for :title, "ë¦¬í¬íŠ¸" %>

<!-- ë¦¬í¬íŠ¸ ì œëª© -->
<div class="mb-8">
  <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“‹ ë¦¬í¬íŠ¸</h2>
  <p class="text-gray-600">BDR í”Œë«í¼ì˜ ìƒì„¸ ë³´ê³ ì„œë¥¼ í™•ì¸í•˜ê³  ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”</p>
</div>

<!-- ê¸°ê°„ ì„ íƒ -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
  <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“… ë¦¬í¬íŠ¸ ê¸°ê°„ ì„¤ì •</h3>
  <%= form_with url: admin_reports_path, method: :get, local: true, class: "flex flex-wrap gap-4" do |f| %>
    <div>
      <%= f.label :start_date, "ì‹œì‘ì¼", class: "block text-sm font-medium text-gray-700" %>
      <%= f.date_field :start_date, value: params[:start_date] || 1.month.ago.to_date, class: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" %>
    </div>
    <div>
      <%= f.label :end_date, "ì¢…ë£Œì¼", class: "block text-sm font-medium text-gray-700" %>
      <%= f.date_field :end_date, value: params[:end_date] || Date.today, class: "mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" %>
    </div>
    <div class="flex items-end">
      <%= f.submit "ë¦¬í¬íŠ¸ ìƒì„±", class: "bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" %>
    </div>
  <% end %>
</div>

<!-- ì£¼ìš” ì§€í‘œ ìš”ì•½ -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <div class="bg-white rounded-lg shadow-md p-6">
    <h4 class="text-sm font-medium text-gray-600 mb-2">ì‹ ê·œ ì‚¬ìš©ì</h4>
    <p class="text-3xl font-bold text-blue-600"><%= @report_stats[:new_users] || 0 %></p>
    <p class="text-xs text-gray-500 mt-1">ì „ ê¸°ê°„ ëŒ€ë¹„ <%= @report_stats[:new_users_growth] || 0 %>%</p>
  </div>
  
  <div class="bg-white rounded-lg shadow-md p-6">
    <h4 class="text-sm font-medium text-gray-600 mb-2">ì´ ê²½ê¸° ìˆ˜</h4>
    <p class="text-3xl font-bold text-green-600"><%= @report_stats[:total_games] || 0 %></p>
    <p class="text-xs text-gray-500 mt-1">ì „ ê¸°ê°„ ëŒ€ë¹„ <%= @report_stats[:games_growth] || 0 %>%</p>
  </div>
  
  <div class="bg-white rounded-lg shadow-md p-6">
    <h4 class="text-sm font-medium text-gray-600 mb-2">ì´ ë§¤ì¶œ</h4>
    <p class="text-3xl font-bold text-purple-600"><%= number_to_currency(@report_stats[:total_revenue] || 0, unit: 'â‚©', precision: 0) %></p>
    <p class="text-xs text-gray-500 mt-1">ì „ ê¸°ê°„ ëŒ€ë¹„ <%= @report_stats[:revenue_growth] || 0 %>%</p>
  </div>
  
  <div class="bg-white rounded-lg shadow-md p-6">
    <h4 class="text-sm font-medium text-gray-600 mb-2">í™œì„± ì‚¬ìš©ì</h4>
    <p class="text-3xl font-bold text-orange-600"><%= @report_stats[:active_users] || 0 %></p>
    <p class="text-xs text-gray-500 mt-1">ì „ì²´ ì‚¬ìš©ìì˜ <%= @report_stats[:active_user_ratio] || 0 %>%</p>
  </div>
</div>

<!-- ìƒì„¸ ë¦¬í¬íŠ¸ ì„¹ì…˜ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <!-- ì‚¬ìš©ì ë¦¬í¬íŠ¸ -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ‘¥ ì‚¬ìš©ì ë¦¬í¬íŠ¸</h3>
    <div class="space-y-4">
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">ì „ì²´ ì‚¬ìš©ì</span>
          <span class="font-medium"><%= @user_report[:total] || 0 %>ëª…</span>
        </div>
      </div>
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">ì‹ ê·œ ê°€ì…</span>
          <span class="font-medium text-green-600"><%= @user_report[:new] || 0 %>ëª…</span>
        </div>
      </div>
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">íƒˆí‡´ ì‚¬ìš©ì</span>
          <span class="font-medium text-red-600"><%= @user_report[:deleted] || 0 %>ëª…</span>
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center">
          <span class="text-gray-600">í‰ê·  ì‚¬ìš© ì‹œê°„</span>
          <span class="font-medium"><%= @user_report[:avg_session_time] || '0' %></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ê²½ê¸° ë¦¬í¬íŠ¸ -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ€ ê²½ê¸° ë¦¬í¬íŠ¸</h3>
    <div class="space-y-4">
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">ì´ ê²½ê¸° ìˆ˜</span>
          <span class="font-medium"><%= @game_report[:total] || 0 %>ê±´</span>
        </div>
      </div>
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">ì™„ë£Œëœ ê²½ê¸°</span>
          <span class="font-medium text-green-600"><%= @game_report[:completed] || 0 %>ê±´</span>
        </div>
      </div>
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">ì·¨ì†Œëœ ê²½ê¸°</span>
          <span class="font-medium text-red-600"><%= @game_report[:cancelled] || 0 %>ê±´</span>
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center">
          <span class="text-gray-600">í‰ê·  ì°¸ê°€ì</span>
          <span class="font-medium"><%= @game_report[:avg_participants] || 0 %>ëª…</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ë§¤ì¶œ ë¦¬í¬íŠ¸ -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ’° ë§¤ì¶œ ë¦¬í¬íŠ¸</h3>
    <div class="space-y-4">
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">ì´ ê±°ë˜ì•¡</span>
          <span class="font-medium"><%= number_to_currency(@revenue_report[:total] || 0, unit: 'â‚©', precision: 0) %></span>
        </div>
      </div>
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">ì„±ê³µ ê±°ë˜</span>
          <span class="font-medium text-green-600"><%= number_to_currency(@revenue_report[:success] || 0, unit: 'â‚©', precision: 0) %></span>
        </div>
      </div>
      <div class="border-b pb-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">í™˜ë¶ˆ ê¸ˆì•¡</span>
          <span class="font-medium text-red-600"><%= number_to_currency(@revenue_report[:refund] || 0, unit: 'â‚©', precision: 0) %></span>
        </div>
      </div>
      <div>
        <div class="flex justify-between items-center">
          <span class="text-gray-600">í‰ê·  ê±°ë˜ì•¡</span>
          <span class="font-medium"><%= number_to_currency(@revenue_report[:average] || 0, unit: 'â‚©', precision: 0) %></span>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¸ê¸° ì½”íŠ¸ ë¦¬í¬íŠ¸ -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸŸï¸ ì¸ê¸° ì½”íŠ¸ TOP 5</h3>
    <div class="space-y-3">
      <% if @popular_courts && @popular_courts.any? %>
        <% @popular_courts.each_with_index do |court, index| %>
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <span class="text-lg font-bold text-gray-400"><%= index + 1 %></span>
              <span class="text-gray-800"><%= court[:name] %></span>
            </div>
            <span class="text-sm text-gray-600"><%= court[:game_count] %>ê²½ê¸°</span>
          </div>
        <% end %>
      <% else %>
        <p class="text-gray-500 text-center py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      <% end %>
    </div>
  </div>
</div>

<!-- ì°¨íŠ¸ ì„¹ì…˜ -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
  <!-- ì¼ë³„ ë§¤ì¶œ ì°¨íŠ¸ -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ ì¼ë³„ ë§¤ì¶œ ì¶”ì´</h3>
    <canvas id="revenueChart" width="400" height="200"></canvas>
  </div>

  <!-- ì‚¬ìš©ì ì¦ê°€ ì°¨íŠ¸ -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“Š ì‚¬ìš©ì ì¦ê°€ ì¶”ì´</h3>
    <canvas id="userGrowthChart" width="400" height="200"></canvas>
  </div>
</div>

<!-- ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ -->
<div class="bg-white rounded-lg shadow-md p-6 mt-8">
  <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“¥ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <%= link_to admin_export_data_path(format: 'pdf', start_date: params[:start_date], end_date: params[:end_date]), 
        class: "bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg text-center transition duration-300" do %>
      <div class="text-2xl mb-2">ğŸ“„</div>
      <div class="font-medium">PDF ë‹¤ìš´ë¡œë“œ</div>
    <% end %>
    
    <%= link_to admin_export_data_path(format: 'csv', start_date: params[:start_date], end_date: params[:end_date]), 
        class: "bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg text-center transition duration-300" do %>
      <div class="text-2xl mb-2">ğŸ“Š</div>
      <div class="font-medium">CSV ë‹¤ìš´ë¡œë“œ</div>
    <% end %>
    
    <%= link_to admin_export_data_path(format: 'xlsx', start_date: params[:start_date], end_date: params[:end_date]), 
        class: "bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg text-center transition duration-300" do %>
      <div class="text-2xl mb-2">ğŸ“‘</div>
      <div class="font-medium">Excel ë‹¤ìš´ë¡œë“œ</div>
    <% end %>
  </div>
</div>

<!-- ì°¨íŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  // ì¼ë³„ ë§¤ì¶œ ì°¨íŠ¸
  const revenueCtx = document.getElementById('revenueChart').getContext('2d');
  const revenueChart = new Chart(revenueCtx, {
    type: 'line',
    data: {
      labels: <%= (@daily_revenue_data&.keys || []).to_json.html_safe %>,
      datasets: [{
        label: 'ì¼ë³„ ë§¤ì¶œ',
        data: <%= (@daily_revenue_data&.values || []).to_json.html_safe %>,
        borderColor: 'rgb(147, 51, 234)',
        backgroundColor: 'rgba(147, 51, 234, 0.1)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'â‚©' + value.toLocaleString();
            }
          }
        }
      }
    }
  });

  // ì‚¬ìš©ì ì¦ê°€ ì°¨íŠ¸
  const userCtx = document.getElementById('userGrowthChart').getContext('2d');
  const userChart = new Chart(userCtx, {
    type: 'bar',
    data: {
      labels: <%= (@daily_user_data&.keys || []).to_json.html_safe %>,
      datasets: [{
        label: 'ì‹ ê·œ ì‚¬ìš©ì',
        data: <%= (@daily_user_data&.values || []).to_json.html_safe %>,
        backgroundColor: 'rgba(59, 130, 246, 0.5)',
        borderColor: 'rgb(59, 130, 246)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
</script>
<% content_for :title, "사용자 관리" %>

<!-- 페이지 제목 -->
<div class="mb-8">
  <h2 class="text-3xl font-bold text-gray-800 mb-2">👥 사용자 관리</h2>
  <p class="text-gray-600">등록된 사용자들을 관리하고 모니터링하세요</p>
</div>

<!-- 필터 및 검색 -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
  <%= form_with url: admin_users_path, method: :get, local: true, class: "flex flex-wrap gap-4 items-end" do |form| %>
    <div class="flex-1 min-w-64">
      <%= form.text_field :search, placeholder: "이름, 이메일, 닉네임 검색", 
                          value: params[:search], 
                          class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" %>
    </div>
    <div>
      <%= form.select :status, 
                      options_for_select([
                        ['전체 상태', ''],
                        ['활성', 'active'],
                        ['정지', 'suspended'],
                        ['비활성', 'inactive'],
                        ['차단', 'banned']
                      ], params[:status]), 
                      {}, 
                      { class: "px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
    </div>
    <div class="flex gap-2">
      <%= form.submit "검색", class: "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-300" %>
      <%= link_to "초기화", admin_users_path, class: "bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-300" %>
    </div>
  <% end %>
</div>

<!-- 사용자 목록 -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">사용자 정보</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">활동</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">가입일</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">관리</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @users.each do |user| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                    <%= user.name[0] %>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">
                    <%= user.name %>
                    <% case user.membership_level %>
                    <% when 'admin' %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 ml-2">
                        관리자
                      </span>
                    <% when 'premium' %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 ml-2">
                        프리미엄
                      </span>
                    <% when 'pro' %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ml-2">
                        프로
                      </span>
                    <% end %>
                  </div>
                  <div class="text-sm text-gray-500">
                    <%= user.email %>
                  </div>
                  <div class="text-sm text-gray-500">
                    닉네임: <%= user.nickname || '미설정' %>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% case user.status %>
              <% when 'active' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  활성
                </span>
              <% when 'suspended' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  정지
                </span>
              <% when 'inactive' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  비활성
                </span>
              <% when 'banned' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-black text-white">
                  차단
                </span>
              <% end %>
              <% if user.suspended_at %>
                <div class="text-xs text-gray-500 mt-1">
                  <%= user.suspended_at.strftime("%Y-%m-%d") %>
                </div>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <div>주최: <%= user.organized_games.count %>건</div>
              <div>참가: <%= user.game_applications.count %>건</div>
              <% if user.premium? %>
                <div class="text-xs text-purple-600">
                  만료: <%= user.premium_expires_at&.strftime("%Y-%m-%d") || "무제한" %>
                </div>
              <% end %>
              <div class="text-xs text-gray-400">
                완성도: <%= user.profile_completion_percentage %>%
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= user.created_at.strftime("%Y-%m-%d") %>
              <div class="text-xs text-gray-400">
                <%= time_ago_in_words(user.created_at) %> 전
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex space-x-2">
                <% if user.status == 'active' %>
                  <!-- 정지 버튼 -->
                  <%= form_with url: admin_user_action_path(user), method: :post, local: true, class: "inline" do |f| %>
                    <%= f.hidden_field :action_type, value: 'suspend' %>
                    <%= f.text_field :reason, placeholder: "정지 사유", class: "px-2 py-1 text-xs border rounded", style: "width: 100px;" %>
                    <%= f.submit "정지", class: "bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs", 
                                 confirm: "정말로 이 사용자를 정지하시겠습니까?" %>
                  <% end %>
                <% elsif user.status == 'suspended' %>
                  <!-- 활성화 버튼 -->
                  <%= form_with url: admin_user_action_path(user), method: :post, local: true, class: "inline" do |f| %>
                    <%= f.hidden_field :action_type, value: 'activate' %>
                    <%= f.submit "활성화", class: "bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs", 
                                 confirm: "이 사용자를 활성화하시겠습니까?" %>
                  <% end %>
                <% end %>
                
                <!-- 관리자 권한 관리 -->
                <% unless user == current_user %>
                  <% if user.admin? %>
                    <%= form_with url: admin_user_action_path(user), method: :post, local: true, class: "inline" do |f| %>
                      <%= f.hidden_field :action_type, value: 'remove_admin' %>
                      <%= f.submit "관리자 해제", class: "bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs", 
                                   confirm: "관리자 권한을 해제하시겠습니까?" %>
                    <% end %>
                  <% else %>
                    <%= form_with url: admin_user_action_path(user), method: :post, local: true, class: "inline" do |f| %>
                      <%= f.hidden_field :action_type, value: 'make_admin' %>
                      <%= f.submit "관리자 지정", class: "bg-purple-500 hover:bg-purple-600 text-white px-2 py-1 rounded text-xs", 
                                   confirm: "이 사용자를 관리자로 지정하시겠습니까?" %>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<% if @users.empty? %>
  <div class="bg-white rounded-lg shadow-md p-8 text-center">
    <div class="text-gray-500">
      <div class="text-4xl mb-4">👥</div>
      <p class="text-lg">조건에 맞는 사용자가 없습니다.</p>
    </div>
  </div>
<% else %>
  <!-- 페이지네이션 -->
  <div class="mt-6 flex justify-center">
    <%= paginate @users %>
  </div>
<% end %>
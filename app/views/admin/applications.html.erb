<% content_for :title, "Ïã†Ï≤≠ Í¥ÄÎ¶¨" %>

<!-- ÌéòÏù¥ÏßÄ Ï†úÎ™© -->
<div class="mb-8">
  <h2 class="text-3xl font-bold text-gray-800 mb-2">üìù Ïã†Ï≤≠ Í¥ÄÎ¶¨</h2>
  <p class="text-gray-600">Í≤ΩÍ∏∞ Ïã†Ï≤≠ ÎÇ¥Ïó≠ÏùÑ Í¥ÄÎ¶¨ÌïòÍ≥† Î™®ÎãàÌÑ∞ÎßÅÌïòÏÑ∏Ïöî</p>
</div>

<!-- ÌïÑÌÑ∞ Î∞è Í≤ÄÏÉâ -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
  <%= form_with url: admin_applications_path, method: :get, local: true, class: "flex flex-wrap gap-4 items-end" do |form| %>
    <div class="flex-1 min-w-64">
      <%= form.text_field :search, placeholder: "ÏÇ¨Ïö©ÏûêÎ™Ö, Í≤ΩÍ∏∞Î™Ö Í≤ÄÏÉâ", 
                          value: params[:search], 
                          class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" %>
    </div>
    <div>
      <%= form.select :status, 
                      options_for_select([
                        ['Ï†ÑÏ≤¥ ÏÉÅÌÉú', ''],
                        ['ÎåÄÍ∏∞Ï§ë', 'pending'],
                        ['Í≤∞Ï†ú ÎåÄÍ∏∞', 'waiting_payment'],
                        ['ÏäπÏù∏Îê®', 'final_approved'],
                        ['Í±∞Ï†àÎê®', 'rejected']
                      ], params[:status]), 
                      {}, 
                      { class: "px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" } %>
    </div>
    <div class="flex gap-2">
      <%= form.submit "Í≤ÄÏÉâ", class: "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-300" %>
      <%= link_to "Ï¥àÍ∏∞Ìôî", admin_applications_path, class: "bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-300" %>
    </div>
  <% end %>
</div>

<!-- Ïã†Ï≤≠ ÌÜµÍ≥Ñ Ïπ¥Îìú -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
  <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">Ï¥ù Ïã†Ï≤≠ Í±¥Ïàò</p>
        <p class="text-2xl font-bold text-blue-600"><%= @applications.count %></p>
      </div>
      <div class="text-3xl">üìù</div>
    </div>
  </div>
  
  <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">ÎåÄÍ∏∞Ï§ë</p>
        <p class="text-2xl font-bold text-orange-600"><%= @applications.where(status: 'pending').count %></p>
      </div>
      <div class="text-3xl">‚è≥</div>
    </div>
  </div>
  
  <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">ÏäπÏù∏Îê®</p>
        <p class="text-2xl font-bold text-green-600"><%= @applications.where(status: 'final_approved').count %></p>
      </div>
      <div class="text-3xl">‚úÖ</div>
    </div>
  </div>
  
  <div class="bg-white rounded-lg shadow-md p-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">Í±∞Ï†àÎê®</p>
        <p class="text-2xl font-bold text-red-600"><%= @applications.where(status: 'rejected').count %></p>
      </div>
      <div class="text-3xl">‚ùå</div>
    </div>
  </div>
</div>

<!-- Ïã†Ï≤≠ Î™©Î°ù -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ïã†Ï≤≠Ïûê</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Í≤ΩÍ∏∞</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÏÉÅÌÉú</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ïã†Ï≤≠Ïùº</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ìè¨ÏßÄÏÖò</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ï∞∏ÏÑù</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Í¥ÄÎ¶¨</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @applications.each do |application| %>
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                    <%= application.user.name[0] %>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">
                    <%= application.user.name %>
                  </div>
                  <div class="text-sm text-gray-500">
                    <%= application.user.email %>
                  </div>
                  <div class="text-sm text-gray-500">
                    <%= application.user.position_names.join(', ') if application.user.position_names %>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if application.game %>
                <div class="text-sm font-medium text-gray-900">
                  <%= link_to application.game.title, game_path(application.game), class: "text-blue-600 hover:text-blue-800" %>
                </div>
                <div class="text-sm text-gray-500">
                  <%= application.game.game_id %>
                </div>
                <div class="text-sm text-gray-500">
                  <%= application.game.scheduled_at.strftime("%Y-%m-%d %H:%M") %>
                </div>
                <div class="text-sm text-gray-500">
                  Ìò∏Ïä§Ìä∏: <%= application.game.organizer&.name || 'Ïïå Ïàò ÏóÜÏùå' %>
                </div>
              <% else %>
                <div class="text-sm font-medium text-gray-500">
                  ÏÇ≠Ï†úÎêú Í≤ΩÍ∏∞
                </div>
                <div class="text-sm text-gray-400">
                  Í≤ΩÍ∏∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§
                </div>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% case application.status %>
              <% when 'pending' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  ÎåÄÍ∏∞Ï§ë
                </span>
              <% when 'waiting_payment' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                  Í≤∞Ï†ú ÎåÄÍ∏∞
                </span>
              <% when 'final_approved' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  ÏäπÏù∏Îê®
                </span>
              <% when 'rejected' %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  Í±∞Ï†àÎê®
                </span>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  <%= application.status %>
                </span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <div class="text-sm font-medium text-gray-900">
                <%= application.applied_at.strftime("%Y-%m-%d") %>
              </div>
              <div class="text-xs text-gray-500">
                <%= application.applied_at.strftime("%H:%M") %>
              </div>
              <div class="text-xs text-gray-400">
                <%= time_ago_in_words(application.applied_at) %> Ï†Ñ
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <% if application.user.position_names.any? %>
                <% application.user.position_names.each do |position| %>
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-1 mb-1">
                    <%= position %>
                  </span>
                <% end %>
              <% else %>
                <span class="text-gray-400">ÎØ∏ÏßÄÏ†ï</span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <% if application.showed_up.nil? %>
                <span class="text-gray-400">-</span>
              <% elsif application.showed_up %>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Ï∞∏ÏÑù
                </span>
              <% else %>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                  Î∂àÏ∞∏
                </span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex space-x-2">
                <% if application.status == 'pending' %>
                  <%= form_with url: admin_application_action_path(application), method: :post, local: true, class: "inline" do |f| %>
                    <%= f.hidden_field :action_type, value: 'approve' %>
                    <%= f.submit "ÏäπÏù∏", class: "bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs", 
                                 confirm: "Ïù¥ Ïã†Ï≤≠ÏùÑ ÏäπÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?" %>
                  <% end %>
                  <%= form_with url: admin_application_action_path(application), method: :post, local: true, class: "inline" do |f| %>
                    <%= f.hidden_field :action_type, value: 'reject' %>
                    <%= f.text_field :rejection_reason, placeholder: "Í±∞Ï†à ÏÇ¨Ïú†", class: "px-2 py-1 text-xs border rounded", style: "width: 80px;" %>
                    <%= f.submit "Í±∞Ï†à", class: "bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs", 
                                 confirm: "Ïù¥ Ïã†Ï≤≠ÏùÑ Í±∞Ï†àÌïòÏãúÍ≤†ÏäµÎãàÍπå?" %>
                  <% end %>
                <% elsif application.status == 'waiting_payment' %>
                  <%= form_with url: admin_application_action_path(application), method: :post, local: true, class: "inline" do |f| %>
                    <%= f.hidden_field :action_type, value: 'confirm_payment' %>
                    <%= f.submit "Í≤∞Ï†ú ÌôïÏù∏", class: "bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs", 
                                 confirm: "Í≤∞Ï†úÎ•º ÌôïÏù∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?" %>
                  <% end %>
                <% elsif application.status == 'final_approved' %>
                  <% if application.showed_up.nil? %>
                    <%= form_with url: admin_application_action_path(application), method: :post, local: true, class: "inline" do |f| %>
                      <%= f.hidden_field :action_type, value: 'mark_attended' %>
                      <%= f.submit "Ï∞∏ÏÑù", class: "bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs" %>
                    <% end %>
                    <%= form_with url: admin_application_action_path(application), method: :post, local: true, class: "inline" do |f| %>
                      <%= f.hidden_field :action_type, value: 'mark_absent' %>
                      <%= f.submit "Î∂àÏ∞∏", class: "bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" %>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<% if @applications.empty? %>
  <div class="bg-white rounded-lg shadow-md p-8 text-center">
    <div class="text-gray-500">
      <div class="text-4xl mb-4">üìù</div>
      <p class="text-lg">Ï°∞Í±¥Ïóê ÎßûÎäî Ïã†Ï≤≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
    </div>
  </div>
<% else %>
  <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò -->
  <div class="mt-6 flex justify-center">
    <%= paginate @applications %>
  </div>
<% end %>
<% content_for :title, "ê²°ì œí•˜ê¸° - BDR" %>

<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-2xl mx-auto px-4">
    <!-- ë’¤ë¡œ ê°€ê¸° -->
    <div class="mb-6">
      <%= link_to "â† ê²½ê¸°ë¡œ ëŒì•„ê°€ê¸°", @game, class: "text-orange-600 hover:text-orange-800 transition duration-300" %>
    </div>

    <!-- í—¤ë” -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <div class="text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ’³ ê²°ì œí•˜ê¸°</h1>
        <p class="text-gray-600">ê²½ê¸° ì°¸ê°€ë¹„ë¥¼ ê²°ì œí•´ì£¼ì„¸ìš”</p>
      </div>
    </div>

    <!-- ê²½ê¸° ì •ë³´ -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ€ ê²½ê¸° ì •ë³´</h2>
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-gray-600">ê²½ê¸°ëª…</span>
          <span class="text-gray-800 font-semibold"><%= @game.title %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">ì¥ì†Œ</span>
          <span class="text-gray-800"><%= @game.venue_name %></span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-600">ì¼ì‹œ</span>
          <span class="text-gray-800">
            <%= @game.scheduled_at.strftime("%Yë…„ %mì›” %dì¼ (%a)") %>
            <%= @game.start_time&.strftime("%H:%M") || @game.scheduled_at.strftime("%H:%M") %> ~ 
            <%= @game.end_time&.strftime("%H:%M") || (@game.scheduled_at + 2.hours).strftime("%H:%M") %>
          </span>
        </div>
        <hr class="my-4">
        <div class="flex justify-between text-lg">
          <span class="text-gray-800 font-semibold">ì°¸ê°€ë¹„</span>
          <span class="text-orange-600 font-bold text-xl"><%= @game.fee_display %></span>
        </div>
      </div>
    </div>

    <!-- ê²°ì œ ë°©ë²• -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ’° ê²°ì œ ë°©ë²•</h2>
      
      <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ -->
      <div class="border border-gray-200 rounded-lg p-4 bg-blue-50 border-blue-200 mb-4">
        <div class="flex items-center mb-3">
          <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center mr-3">
            <span class="text-white text-sm">âœ“</span>
          </div>
          <div class="text-lg font-semibold text-gray-800">ğŸ’³ í† ìŠ¤í˜ì´ë¨¼ì¸ </div>
        </div>
        
        <!-- í† ìŠ¤í˜ì´ë¨¼ì¸  ì„¤ëª… -->
        <div class="ml-9 text-sm text-gray-600">
          <p class="mb-3">ì•ˆì „í•˜ê³  í¸ë¦¬í•œ ì˜¨ë¼ì¸ ê²°ì œ ì„œë¹„ìŠ¤</p>
          <div class="flex items-center space-x-2 text-xs">
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">ì¹´ë“œ</span>
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">ê³„ì¢Œì´ì²´</span>
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">ì¹´ì¹´ì˜¤í˜ì´</span>
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">í˜ì´ì½”</span>
            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">í† ìŠ¤í˜ì´</span>
          </div>
        </div>
      </div>
        
      <!-- ê²°ì œ ì§„í–‰ ë²„íŠ¼ -->
      <div class="mt-8 text-center">
        <button type="button" id="toss-payment-btn" disabled class="w-full bg-gray-400 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300">
          ğŸ’³ í† ìŠ¤í˜ì´ë¨¼ì¸ ë¡œ ê²°ì œí•˜ê¸° (ë¡œë”© ì¤‘...)
        </button>
      </div>
    </div>

    <!-- ì£¼ì˜ì‚¬í•­ -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
      <div class="text-yellow-800 font-semibold mb-2">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
      <ul class="text-yellow-700 text-sm space-y-1">
        <li>â€¢ ê²°ì œ í›„ ì·¨ì†ŒëŠ” ê²½ê¸° ì‹œì‘ 24ì‹œê°„ ì „ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
        <li>â€¢ í—ˆìœ„ ì •ë³´ ì…ë ¥ ì‹œ ì°¸ê°€ê°€ ì·¨ì†Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
        <li>â€¢ ë¬¸ì˜ì‚¬í•­ì€ ê³ ê°ì„¼í„°ë¡œ ì—°ë½í•´ì£¼ì„¸ìš”</li>
      </ul>
    </div>
  </div>
</div>

<!-- í† ìŠ¤í˜ì´ë¨¼ì¸  SDK v1 -->
<script src="https://js.tosspayments.com/v1/payment"></script>

<script>
// í† ìŠ¤í˜ì´ë¨¼ì¸  í´ë¼ì´ì–¸íŠ¸ í‚¤ (í…ŒìŠ¤íŠ¸ìš©)
const clientKey = "test_ck_D5GePWvyJnrK0W0k6q8gLzN97Eoq"
console.log('Loading TossPayments with client key:', clientKey)

let tossPayments;

// ê²°ì œ ì •ë³´
const paymentInfo = {
  amount: <%= @game.fee %>,
  orderId: "BDR-<%= @game.game_id %>-<%= @application.id %>-<%= Time.current.to_i %>",
  orderName: "<%= @game.title %> ì°¸ê°€ë¹„",
  customerName: "<%= current_user.name %>",
  customerEmail: "<%= current_user.email %>",
  successUrl: "<%= request.protocol + request.host_with_port %>/payments/success",
  failUrl: "<%= request.protocol + request.host_with_port %>/payments/fail"
}

// í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ì²˜ë¦¬
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing TossPayments...')
  
  const tossBtn = document.getElementById('toss-payment-btn')
  
  if (!tossBtn) {
    console.error('TossPayments button not found!')
    return
  }
  
  console.log('TossPayments button found:', tossBtn)
  console.log('Payment info:', paymentInfo)
  
  // TossPayments ì´ˆê¸°í™” ëŒ€ê¸° (SDK v1)
  function initializeTossPayments() {
    if (typeof TossPayments === 'undefined') {
      console.log('TossPayments SDK not loaded yet, waiting...')
      setTimeout(initializeTossPayments, 100)
      return
    }
    
    if (!tossPayments) {
      try {
        tossPayments = TossPayments(clientKey)
        console.log('TossPayments initialized successfully:', tossPayments)
        console.log('TossPayments methods:', Object.keys(tossPayments))
      } catch (error) {
        console.error('Failed to initialize TossPayments:', error)
        return
      }
    }
    
    // ê²°ì œ ë²„íŠ¼ í™œì„±í™”
    tossBtn.disabled = false
    tossBtn.textContent = 'ğŸ’³ í† ìŠ¤í˜ì´ë¨¼ì¸ ë¡œ ê²°ì œí•˜ê¸°'
    tossBtn.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105'
    console.log('TossPayments ready, button enabled')
  }
  
  // ì´ˆê¸°í™” ì‹œì‘
  initializeTossPayments()
  
  // í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ ë²„íŠ¼ í´ë¦­
  tossBtn.addEventListener('click', function() {
    console.log('TossPayments button clicked!')
    
    if (!tossPayments) {
      console.error('TossPayments not initialized!')
      alert('ê²°ì œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.')
      return
    }
    
    try {
      console.log('Requesting payment with:', {
        method: "CARD",
        amount: paymentInfo.amount,
        orderId: paymentInfo.orderId,
        orderName: paymentInfo.orderName,
        customerName: paymentInfo.customerName,
        customerEmail: paymentInfo.customerEmail,
        successUrl: paymentInfo.successUrl,
        failUrl: paymentInfo.failUrl
      })
      
      // í† ìŠ¤í˜ì´ë¨¼ì¸  SDK v1 ì‚¬ìš©ë²•
      tossPayments.requestPayment('ì¹´ë“œ', {
        amount: paymentInfo.amount,
        orderId: paymentInfo.orderId,
        orderName: paymentInfo.orderName,
        customerName: paymentInfo.customerName,
        customerEmail: paymentInfo.customerEmail,
        successUrl: paymentInfo.successUrl,
        failUrl: paymentInfo.failUrl,
      }).catch(function (error) {
        console.error('Payment error:', error)
        if (error.code === 'USER_CANCEL') {
          alert('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.')
        } else {
          alert('ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message)
        }
      })
    } catch (error) {
      console.error('Payment request failed:', error)
      alert('ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message)
    }
  })
})
</script>
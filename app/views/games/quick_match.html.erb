<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-4xl mx-auto px-4">
    <!-- 3-Second Rule Progress -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">âš¡ 3ì´ˆ ë£° ë§¤ì¹­</h1>
      
      <div class="flex justify-center items-center mb-8">
        <div class="flex items-center space-x-4">
          <div id="step1-icon" class="bg-orange-500 text-white rounded-full w-10 h-10 flex items-center justify-center font-bold">1</div>
          <div id="step1-text" class="text-orange-500 font-semibold">ìœ„ì¹˜ ì„ íƒ</div>
          <div class="w-12 h-1 bg-gray-300"></div>
          <div id="step2-icon" class="bg-gray-300 text-gray-500 rounded-full w-10 h-10 flex items-center justify-center font-bold">2</div>
          <div id="step2-text" class="text-gray-500">ê²½ê¸° ì„ íƒ</div>
          <div class="w-12 h-1 bg-gray-300"></div>
          <div id="step3-icon" class="bg-gray-300 text-gray-500 rounded-full w-10 h-10 flex items-center justify-center font-bold">3</div>
          <div id="step3-text" class="text-gray-500">ì‹ ì²­ ì™„ë£Œ</div>
        </div>
      </div>

      <p id="step-description" class="text-center text-gray-600 mb-6">1ë‹¨ê³„: í˜„ì¬ ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”</p>
    </div>

    <!-- Step 1: ìœ„ì¹˜ ì„ íƒ -->
    <div id="step1-content" class="bg-white rounded-lg shadow-lg p-8">
      <div class="text-center">
        <div class="mb-8">
          <div class="inline-flex items-center justify-center w-32 h-32 bg-orange-100 rounded-full mb-4">
            <span class="text-6xl">ğŸ“</span>
          </div>
          <h2 class="text-2xl font-bold text-gray-800 mb-4">í˜„ì¬ ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°</h2>
          <p class="text-gray-600 mb-6">ê°€ê¹Œìš´ ê²½ê¸°ë¥¼ ì°¾ê¸° ìœ„í•´ í˜„ì¬ ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.</p>
        </div>
        
        <div id="location-display" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-600">í˜„ì¬ ìœ„ì¹˜:</p>
          <p id="current-location" class="font-semibold text-gray-800"></p>
        </div>
        
        <button id="get-location-btn" onclick="getCurrentLocation()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold px-8 py-4 rounded-lg text-lg transition duration-300 transform hover:scale-105 mb-4">
          ğŸ“¡ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        </button>
        
        <button id="next-to-step2" onclick="goToStep2()" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold px-8 py-4 rounded-lg text-lg transition duration-300">
          ë‹¤ìŒ ë‹¨ê³„ë¡œ â†’
        </button>
        
        <div id="location-error" class="hidden mt-4 p-4 bg-red-50 text-red-600 rounded-lg">
          ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.
        </div>
      </div>
    </div>

    <!-- Step 2: ê²½ê¸° ì„ íƒ -->
    <div id="step2-content" class="hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 mb-4">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold text-gray-800">ê°€ê¹Œìš´ ê²½ê¸° ëª©ë¡</h2>
          <button onclick="goToStep1()" class="text-blue-600 hover:text-blue-800">
            â† ìœ„ì¹˜ ë‹¤ì‹œ ì„ íƒ
          </button>
        </div>
      </div>
      
      <div id="games-loading" class="bg-white rounded-lg shadow-lg p-8 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"></div>
        <p class="text-gray-600">ê°€ê¹Œìš´ ê²½ê¸°ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p>
      </div>
      
      <div id="games-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- ê²½ê¸° ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
      </div>
    </div>

    <!-- Step 3: ì‹ ì²­ ì™„ë£Œ -->
    <div id="step3-content" class="hidden bg-white rounded-lg shadow-lg p-8 text-center">
      <div class="inline-flex items-center justify-center w-32 h-32 bg-green-100 rounded-full mb-6">
        <span class="text-6xl">âœ…</span>
      </div>
      <h2 class="text-3xl font-bold text-gray-800 mb-4">ì‹ ì²­ ì™„ë£Œ!</h2>
      <p class="text-lg text-gray-600 mb-8">ê²½ê¸° ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
      
      <div id="game-details" class="bg-gray-50 rounded-lg p-6 mb-8 text-left">
        <!-- ì‹ ì²­í•œ ê²½ê¸° ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë¨ -->
      </div>
      
      <div class="space-x-4">
        <%= link_to "ë‚´ ê²½ê¸° ë³´ê¸°", profile_path, class: "bg-blue-500 hover:bg-blue-600 text-white font-bold px-6 py-3 rounded-lg transition duration-300" %>
        <%= link_to "í™ˆìœ¼ë¡œ", root_path, class: "bg-gray-500 hover:bg-gray-600 text-white font-bold px-6 py-3 rounded-lg transition duration-300" %>
      </div>
    </div>

    <!-- Back Button -->
    <div class="text-center mt-8">
      <%= link_to "â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°", root_path, 
          class: "text-gray-600 hover:text-gray-800 transition duration-300" %>
    </div>
  </div>
</div>

<script>
  let userLocation = null;
  let nearbyGames = <%= @nearby_games.to_json(include: { court: { only: [:id, :name, :address, :latitude, :longitude, :court_type] }, organizer: { only: [:name, :nickname] } }).html_safe %>;
  
  function getCurrentLocation() {
    const btn = document.getElementById('get-location-btn');
    btn.disabled = true;
    btn.textContent = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };
          
          // ì—­ì§€ì˜¤ì½”ë”©ìœ¼ë¡œ ì£¼ì†Œ í‘œì‹œ
          displayLocation(userLocation);
          
          // ë‹¤ìŒ ë²„íŠ¼ í‘œì‹œ
          document.getElementById('next-to-step2').classList.remove('hidden');
          btn.classList.add('hidden');
        },
        (error) => {
          document.getElementById('location-error').classList.remove('hidden');
          btn.disabled = false;
          btn.textContent = 'ğŸ“¡ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°';
        }
      );
    } else {
      alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      btn.disabled = false;
    }
  }
  
  function displayLocation(location) {
    document.getElementById('location-display').classList.remove('hidden');
    document.getElementById('current-location').textContent = 
      `ìœ„ë„: ${location.latitude.toFixed(6)}, ê²½ë„: ${location.longitude.toFixed(6)}`;
    
    // ì‹¤ì œë¡œëŠ” ì—­ì§€ì˜¤ì½”ë”© APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ì†Œë¥¼ í‘œì‹œ
    // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì¢Œí‘œë§Œ í‘œì‹œ
  }
  
  function goToStep2() {
    // UI ì—…ë°ì´íŠ¸
    document.getElementById('step1-content').classList.add('hidden');
    document.getElementById('step2-content').classList.remove('hidden');
    
    // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateProgress(2);
    
    // ê°€ê¹Œìš´ ê²½ê¸° ì°¾ê¸°
    findNearbyGames();
  }
  
  function goToStep1() {
    document.getElementById('step2-content').classList.add('hidden');
    document.getElementById('step1-content').classList.remove('hidden');
    updateProgress(1);
  }
  
  function updateProgress(step) {
    // ëª¨ë“  ë‹¨ê³„ ì´ˆê¸°í™”
    for (let i = 1; i <= 3; i++) {
      const icon = document.getElementById(`step${i}-icon`);
      const text = document.getElementById(`step${i}-text`);
      
      if (i < step) {
        icon.classList.add('bg-green-500', 'text-white');
        icon.classList.remove('bg-orange-500', 'bg-gray-300', 'text-gray-500');
        text.classList.add('text-green-500');
        text.classList.remove('text-orange-500', 'text-gray-500');
      } else if (i === step) {
        icon.classList.add('bg-orange-500', 'text-white');
        icon.classList.remove('bg-green-500', 'bg-gray-300', 'text-gray-500');
        text.classList.add('text-orange-500');
        text.classList.remove('text-green-500', 'text-gray-500');
      } else {
        icon.classList.add('bg-gray-300', 'text-gray-500');
        icon.classList.remove('bg-green-500', 'bg-orange-500', 'text-white');
        text.classList.add('text-gray-500');
        text.classList.remove('text-green-500', 'text-orange-500');
      }
    }
    
    // ì„¤ëª… í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    const descriptions = {
      1: '1ë‹¨ê³„: í˜„ì¬ ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”',
      2: '2ë‹¨ê³„: ì°¸ê°€í•  ê²½ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”',
      3: '3ë‹¨ê³„: ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'
    };
    document.getElementById('step-description').textContent = descriptions[step];
  }
  
  function findNearbyGames() {
    // ê±°ë¦¬ ê³„ì‚° ë° ì •ë ¬
    const gamesWithDistance = nearbyGames.map(game => {
      if (game.court && game.court.latitude && game.court.longitude) {
        const distance = calculateDistance(
          userLocation.latitude,
          userLocation.longitude,
          game.court.latitude,
          game.court.longitude
        );
        return { ...game, distance };
      }
      return { ...game, distance: 999 }; // ìœ„ì¹˜ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°
    }).sort((a, b) => a.distance - b.distance);
    
    // ë¡œë”© ìˆ¨ê¸°ê³  ê²°ê³¼ í‘œì‹œ
    setTimeout(() => {
      document.getElementById('games-loading').classList.add('hidden');
      displayGames(gamesWithDistance);
    }, 1000);
  }
  
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // ì§€êµ¬ ë°˜ê²½ (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  
  function displayGames(games) {
    const gamesList = document.getElementById('games-list');
    
    if (games.length === 0) {
      gamesList.innerHTML = `
        <div class="col-span-2 bg-white rounded-lg shadow-lg p-8 text-center">
          <p class="text-gray-600">í˜„ì¬ ì°¸ê°€ ê°€ëŠ¥í•œ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      `;
      return;
    }
    
    gamesList.innerHTML = games.map(game => `
      <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition duration-300 border-2 hover:border-orange-500">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-xl font-semibold text-gray-800">${game.court.name}</h3>
          <span class="bg-orange-100 text-orange-800 text-xs px-3 py-1 rounded-full font-bold">
            ${game.distance.toFixed(1)}km
          </span>
        </div>
        
        <div class="space-y-3 mb-6">
          <div class="flex items-center text-gray-600">
            <span class="w-6">ğŸ“</span>
            <span class="text-sm">${game.court.address}</span>
          </div>
          <div class="flex items-center text-gray-600">
            <span class="w-6">â°</span>
            <span>${new Date(game.scheduled_at).toLocaleDateString('ko-KR')} ${game.start_time || new Date(game.scheduled_at).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
          </div>
          <div class="flex items-center text-gray-600">
            <span class="w-6">ğŸ‘¥</span>
            <span>${game.confirmed_players_count || 0}/${game.max_players}ëª…</span>
          </div>
          <div class="flex items-center text-gray-600">
            <span class="w-6">ğŸ€</span>
            <span>${game.court.court_type === 'indoor' ? 'ì‹¤ë‚´' : 'ì‹¤ì™¸'} ì½”íŠ¸</span>
          </div>
        </div>
        
        <button onclick="selectGame(${game.id}, '${game.court.name}', '${new Date(game.scheduled_at).toLocaleDateString('ko-KR')}', '${game.court.address}')" 
                class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold px-6 py-3 rounded-lg transition duration-300 transform hover:scale-105">
          âš¡ ì‹ ì²­í•˜ê¸°
        </button>
      </div>
    `).join('');
  }
  
  function selectGame(gameId, courtName, date, address) {
    // ì‹¤ì œë¡œëŠ” ì„œë²„ì— ì‹ ì²­ ìš”ì²­ì„ ë³´ë‚´ì•¼ í•¨
    fetch(`/games/${gameId}/apply`, {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success || true) { // ì„ì‹œë¡œ í•­ìƒ ì„±ê³µ ì²˜ë¦¬
        goToStep3(gameId, courtName, date, address);
      } else {
        alert(data.message || 'ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    })
    .catch(() => {
      // ì„ì‹œë¡œ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
      goToStep3(gameId, courtName, date, address);
    });
  }
  
  function goToStep3(gameId, courtName, date, address) {
    document.getElementById('step2-content').classList.add('hidden');
    document.getElementById('step3-content').classList.remove('hidden');
    updateProgress(3);
    
    // ì‹ ì²­í•œ ê²½ê¸° ì •ë³´ í‘œì‹œ
    document.getElementById('game-details').innerHTML = `
      <h3 class="font-bold text-gray-800 mb-3">ì‹ ì²­í•œ ê²½ê¸° ì •ë³´</h3>
      <div class="space-y-2">
        <p><span class="text-gray-600">ê²½ê¸°ì¥:</span> <span class="font-semibold">${courtName}</span></p>
        <p><span class="text-gray-600">ë‚ ì§œ:</span> <span class="font-semibold">${date}</span></p>
        <p><span class="text-gray-600">ì£¼ì†Œ:</span> <span class="font-semibold">${address}</span></p>
      </div>
    `;
  }
</script>
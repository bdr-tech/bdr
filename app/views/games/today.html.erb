<div class="min-h-screen bg-gray-50 py-8">
  <div class="max-w-6xl mx-auto px-4">
    <!-- 3ì´ˆë£° í—¤ë” -->
    <div class="bg-gradient-to-r from-orange-500 to-red-500 rounded-lg shadow-lg p-8 mb-8 text-white">
      <div class="flex flex-col md:flex-row md:items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold mb-2">âš¡ 3ì´ˆë£° ê²½ê¸°</h1>
          <p class="text-lg opacity-90">í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ê²½ê¸°ë¥¼ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤</p>
          <p class="text-sm opacity-75 mt-2">3ë²ˆì˜ í´ë¦­ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì°¸ê°€í•˜ì„¸ìš”!</p>
        </div>
        <div class="mt-4 md:mt-0">
          <button id="enable-location" class="bg-white text-orange-500 hover:text-orange-600 px-6 py-3 rounded-lg font-semibold transition duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
            <span class="inline-block mr-2">ğŸ“</span> ë‚´ ìœ„ì¹˜ ì°¾ê¸°
          </button>
        </div>
      </div>
    </div>

    <!-- ìœ„ì¹˜ ì •ë³´ í‘œì‹œ -->
    <div id="location-info" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <div class="flex items-center">
        <span class="text-2xl mr-3">ğŸ“</span>
        <div>
          <p class="text-sm font-medium text-blue-800">í˜„ì¬ ìœ„ì¹˜</p>
          <p id="current-location" class="text-lg text-blue-900 font-semibold">ìœ„ì¹˜ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...</p>
        </div>
      </div>
    </div>

    <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="loading-spinner" class="hidden text-center py-8">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-500 mr-3"></div>
        <span class="text-lg text-gray-600">ê°€ê¹Œìš´ ê²½ê¸°ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</span>
      </div>
    </div>

    <!-- ì¶”ì²œ ê²½ê¸° ëª©ë¡ -->
    <div id="recommended-games" class="space-y-4">
      <% if @games.any? %>
        <% @games.each_with_index do |game, index| %>
          <div class="game-card bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300 overflow-hidden" 
               data-lat="<%= game.court&.latitude || Location.find_by(city: game.city, district: game.district)&.latitude %>" 
               data-lng="<%= game.court&.longitude || Location.find_by(city: game.city, district: game.district)&.longitude %>">
            <div class="flex flex-col md:flex-row">
              <!-- ê²½ê¸° ì •ë³´ -->
              <div class="flex-1 p-6">
                <div class="flex items-start justify-between mb-4">
                  <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1"><%= game.title %></h3>
                    <p class="text-gray-600">
                      <span class="inline-block mr-2">ğŸ“</span>
                      <%= game.court&.name || game.venue_name %> â€¢ <%= game.district %>, <%= game.city %>
                    </p>
                  </div>
                  <div class="text-right">
                    <div class="text-2xl font-bold text-orange-500">
                      <%= game.confirmed_players_count %>/<%= game.max_players %>
                    </div>
                    <div class="text-xs text-gray-500">ì°¸ê°€ì</div>
                  </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                  <div class="flex items-center text-sm">
                    <span class="text-blue-500 mr-2">ğŸ“…</span>
                    <span class="text-gray-700"><%= game.scheduled_at.strftime("%mì›” %dì¼") %></span>
                  </div>
                  <div class="flex items-center text-sm">
                    <span class="text-green-500 mr-2">â°</span>
                    <span class="text-gray-700"><%= game.start_time.strftime("%H:%M") %></span>
                  </div>
                  <div class="flex items-center text-sm">
                    <span class="text-purple-500 mr-2">ğŸ¯</span>
                    <span class="text-gray-700"><%= game.level_name %></span>
                  </div>
                  <div class="flex items-center text-sm">
                    <span class="text-yellow-500 mr-2">ğŸ’°</span>
                    <span class="text-gray-700"><%= game.fee_display %></span>
                  </div>
                </div>

                <!-- ê±°ë¦¬ í‘œì‹œ -->
                <div class="distance-info hidden bg-gray-50 rounded-lg px-3 py-2 inline-block">
                  <span class="text-sm text-gray-600">ğŸš¶ ì•½ <span class="distance-value font-semibold text-gray-800">ê³„ì‚°ì¤‘...</span></span>
                </div>
              </div>

              <!-- ì•¡ì…˜ ë²„íŠ¼ -->
              <div class="bg-gray-50 p-6 flex items-center justify-center border-t md:border-t-0 md:border-l">
                <% if game.confirmed_players_count < game.max_players %>
                  <% if index == 0 %>
                    <%= link_to quick_join_path(game), class: "relative" do %>
                      <div class="absolute -top-2 -right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full font-semibold animate-pulse">
                        ì¶”ì²œ
                      </div>
                      <div class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-xl transition duration-300 transform hover:scale-105">
                        âš¡ 3ì´ˆ ì°¸ê°€
                      </div>
                    <% end %>
                  <% else %>
                    <%= link_to "ìƒì„¸ë³´ê¸°", game_path(game), 
                          class: "bg-white border-2 border-orange-500 text-orange-500 hover:bg-orange-500 hover:text-white px-6 py-3 rounded-lg font-semibold transition duration-300" %>
                  <% end %>
                <% else %>
                  <span class="bg-gray-300 text-gray-600 px-6 py-3 rounded-lg font-semibold">ë§ˆê°</span>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="bg-white rounded-lg shadow-lg p-8 text-center">
          <div class="text-6xl mb-4">ğŸ“</div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">ì˜¤ëŠ˜ ì°¸ê°€ ê°€ëŠ¥í•œ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
          <p class="text-gray-600 mb-6">ë‚´ì¼ ê²½ê¸°ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ìƒˆë¡œìš´ ê²½ê¸°ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>
          <div class="space-y-3">
            <%= link_to "ì „ì²´ ê²½ê¸° ë³´ê¸°", games_path, 
                  class: "block bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold transition duration-300" %>
            <%= link_to "ê²½ê¸° ë§Œë“¤ê¸°", new_game_path, 
                  class: "block bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-semibold transition duration-300" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
// ìœ„ì¹˜ ê¸°ë°˜ ê²½ê¸° ì¶”ì²œ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
  const enableLocationBtn = document.getElementById('enable-location');
  const locationInfo = document.getElementById('location-info');
  const currentLocationEl = document.getElementById('current-location');
  const loadingSpinner = document.getElementById('loading-spinner');
  const gameCards = document.querySelectorAll('.game-card');
  
  // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine formula)
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // ì§€êµ¬ ë°˜ê²½ (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const d = R * c;
    return d;
  }
  
  // ê±°ë¦¬ í‘œì‹œ í˜•ì‹
  function formatDistance(km) {
    if (km < 1) {
      return (km * 1000).toFixed(0) + 'm';
    } else {
      return km.toFixed(1) + 'km';
    }
  }
  
  // ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­ ë° ê²½ê¸° ì •ë ¬
  enableLocationBtn.addEventListener('click', function() {
    if (navigator.geolocation) {
      loadingSpinner.classList.remove('hidden');
      enableLocationBtn.disabled = true;
      enableLocationBtn.textContent = 'ìœ„ì¹˜ í™•ì¸ ì¤‘...';
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const userLat = position.coords.latitude;
          const userLng = position.coords.longitude;
          
          // ìœ„ì¹˜ ì •ë³´ í‘œì‹œ
          locationInfo.classList.remove('hidden');
          
          // í•œêµ­ ì£¼ìš” ë„ì‹œ ì¢Œí‘œë¡œ ëŒ€ëµì ì¸ ìœ„ì¹˜ í‘œì‹œ
          const koreanCities = {
            'ì„œìš¸': { lat: 37.5665, lng: 126.9780 },
            'ë¶€ì‚°': { lat: 35.1796, lng: 129.0756 },
            'ëŒ€êµ¬': { lat: 35.8714, lng: 128.6014 },
            'ì¸ì²œ': { lat: 37.4563, lng: 126.7052 },
            'ê´‘ì£¼': { lat: 35.1595, lng: 126.8526 },
            'ëŒ€ì „': { lat: 36.3504, lng: 127.3845 },
            'ìš¸ì‚°': { lat: 35.5384, lng: 129.3114 }
          };
          
          // ê°€ì¥ ê°€ê¹Œìš´ ë„ì‹œ ì°¾ê¸°
          let closestCity = 'ì„œìš¸';
          let minDistance = Infinity;
          
          for (const [city, coords] of Object.entries(koreanCities)) {
            const distance = calculateDistance(userLat, userLng, coords.lat, coords.lng);
            if (distance < minDistance) {
              minDistance = distance;
              closestCity = city;
            }
          }
          
          currentLocationEl.textContent = `${closestCity} ê·¼ì²˜`;
          
          // ê° ê²½ê¸°ê¹Œì§€ì˜ ê±°ë¦¬ ê³„ì‚° ë° í‘œì‹œ
          const gameDistances = [];
          gameCards.forEach((card, index) => {
            const gameLat = parseFloat(card.dataset.lat);
            const gameLng = parseFloat(card.dataset.lng);
            
            if (gameLat && gameLng) {
              const distance = calculateDistance(userLat, userLng, gameLat, gameLng);
              gameDistances.push({
                element: card,
                distance: distance,
                index: index
              });
              
              // ê±°ë¦¬ í‘œì‹œ
              const distanceEl = card.querySelector('.distance-value');
              if (distanceEl) {
                distanceEl.textContent = formatDistance(distance);
                card.querySelector('.distance-info').classList.remove('hidden');
              }
            }
          });
          
          // ê±°ë¦¬ìˆœìœ¼ë¡œ ì •ë ¬
          gameDistances.sort((a, b) => a.distance - b.distance);
          
          // DOM ì¬ì •ë ¬
          const container = document.getElementById('recommended-games');
          gameDistances.forEach(item => {
            container.appendChild(item.element);
          });
          
          loadingSpinner.classList.add('hidden');
          enableLocationBtn.textContent = 'ìœ„ì¹˜ ì—…ë°ì´íŠ¸';
          enableLocationBtn.disabled = false;
          
          // ê°€ì¥ ê°€ê¹Œìš´ ê²½ê¸° í•˜ì´ë¼ì´íŠ¸
          if (gameDistances.length > 0) {
            gameDistances[0].element.classList.add('ring-2', 'ring-orange-500');
          }
        },
        function(error) {
          loadingSpinner.classList.add('hidden');
          enableLocationBtn.textContent = 'ğŸ“ ë‚´ ìœ„ì¹˜ ì°¾ê¸°';
          enableLocationBtn.disabled = false;
          
          let errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = 'ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
              break;
            case error.TIMEOUT:
              errorMessage = 'ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
              break;
          }
          
          alert(errorMessage);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
  });
  
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ìœ„ì¹˜ í™•ì¸ (ì„ íƒì‚¬í•­)
  // enableLocationBtn.click();
});
</script>